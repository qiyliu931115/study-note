# 如果数据量过大 如何进行平滑扩容

平滑扩容 意味着服务不重启

三种级别的平滑扩容

- database 库级别的平滑 原来有4个库 把其中两个库 移动到另外一个服务器
- table 表级别 订单一 订单二 订单三 把其中一张表 移动到另外一个服务器
- row 行级别 根据分片 进行rehash的计算 类似hashmap 对数据的可以进入rehash 与为我们当前的table length -1 然后定位出最新的节点位置
  行数据真的能平滑扩容吗  美团13年 美团外卖APP正式上线 14年 每日10万单 到16年 每天500万单 到19年 日单每天7500万
  这么大数据想要进行基于行的水平扩容 是非常难的事情

# 先说美团 美团用的是DB proxy， DB proxy分为三层

### 第一层 权限控制管理层
有人问是不是微服务账号登录的权限管理呢 没那么简单

在美团订单有大商家的概念， 用商家ID进行水平拆分 大商家有大的数据量 会有极大的数据倾斜

这个商家ID取模出来的数据 经常往几个节点里面跑 大商家要单独管理

在权限管理层这一层 我们可以精细到当前某一个用户某一个商家只能访问指定的DB节点

当大商家出现的时候我们会将这个大商家单独运维起来 而我们有相应的资源对大商家进行数据存储和查询

这套管理2016年就有了 

### 第二层 DB的SQL分析

这个SQL分析是做什么的 解决join查询 解决分布式情况下的join查询

我们怎么解决在一定场景下 提升join查询的能力

需要在DB SQL 分析层 使用lemon插件分析SQL 看两张表是不是在同一个节点上 如果在同一个DB节点

如果这两张表在同一个DB节点上 那么我们的SQL会将整个SQL发送到这个节点 在该节点进行join查询

如果 其中一张表是我们的这个商家ID查到了A分片，另外一张表跟着一些商品清单分片到了B分片，怎么办

这个时候就需要进行SQL的拆分 商家的数据进一个节点 join部分的SQL进另外一个节点

多说两点 我们可以把一些小表 百万以内的并且常用的表数据 我们会将这个表作为一个广播表 存储到我们的每一个MYSQL节点里

### 第三层 DB连接层 DB的connection DB的thread pool

# 淘宝

## DRDS 支持平滑扩容

基于库的平滑扩容

Database0 Database1 在一个服务器上

购买新的服务器 将D1复制到新服务器上 这个时候D0和D1一直对外提供服务 这个时候新服务器的D1可能有些增量数据的差异 阿里的DRDS会进行增量性的填补

对新服务器的D1和老服务器的D1进行数据校验 这个时候老服务器的D1是禁止写入的

校验完成后 配置切换 之前指向一个服务器 现在指向两个服务器 切换完后 删除老服务器的D1

这个操作用户自己就可以 不需要联系可恶 在UI管理工具上操作就好

## 2N平滑扩容

基于行的平滑扩容

服务器1 有一个Database0数据库 现在业务翻倍

现在需要买一个服务器2 将服务器1的Database0约一半的数据移动到服务器2的Database0

首先 将服务器1的D0进行镜像复制到服务器2的D0 并进行增量数据的同步

当达到一致性的时候 需要暂时的极短时间的停止对写入操作 做校验完成后

然后做分片的配置（简单的说可以取模 模2）

那新数据进来的时候就按照模2的形式进行分片写入各种的数据库

这个时候 两个库都有全量的老数据 

最后将不属于各种数据库的数据删除
