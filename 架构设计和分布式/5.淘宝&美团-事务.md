## 本地消息表是目前互联网用的比较多的维持多DB数据最终一致性的方式

## 对于之前的美团订单的问题

既然美团有三份数据冗余 还有一个elastic search 那么可不可以美团只留一份数据

例如用户ID为分片数据 其他的商家 订单等复杂查询 都在elastic search

但是我们不光要看elastic search 查询快啊 还要看es写入和修改快不快

elastic search存储的是最终状态的订单数据 

我在美团点了份外卖 现在是等待商家接单 然后是等待快递员接单 然后是配送中 最后完成 才会入ES

或者我退款了 发起退款操作 退款成功 才会入ES 因为ES本来属于OLAP数据库 不能进行频繁的修改

## 第二个问题 淘宝订单设计问题

有的公司也是用的二级索引 发现没办法很快的进行分页查询 分页性能不好

因为在全局二级索引表里面 我用商家ID直接拉一大页 而且数据分散各个分片里面

我们要想MySQL辅助索引的特性 我们可以在这个索引表放很多字段

我们在分页的时候 要考虑 我们需要的概况数据的字段有哪些 比如商家进行分页 比如订单号得有 用户ID得有 配送地址得有 价格得有 商品信息得有

这个五个字段就需要放到所以表里面 如果商家要来查询的话 直接从二级索引表拿到所有的字段数据

如果要看详细信息 那么就点击信息 用订单号 去访问订单主表

建全局二级索引表要根据业务需求添加字段

## 事务

我们经常聊的最终一致性 在淘宝的DRDS称之为柔性事务

强一致性也分为 非分布式强一致性事务 和分布式强一致性事务

先说美团的三份MySQL数据（用户，订单，商家）和elastic search数据

首先一个订单进来之后 美团只保证一个MySQL数据存储成功（用户，订单，商家一个），成功了就返回，不会同时存储第二个和第三个数据

第二份 和第三份靠最终一致性（柔性事务）保证，我们接触很多ETL相关的技术 databus canal等等

比如使用databus从MySQL中一个数据库 更新到elastic search

那么MySQL的第二份和第三份数据呢 也是用data bus（data bus就是提供数据中继的） 异步执行 异步监听binlog 执行入库 实现最终一致性

## 那么有没有强一致性呢

回到MySQL三个分片数据中， 我们除了存储订单数据以外 我们还要存储一个 本地消息表 （订单表 + 本地消息表 强一致）

这个本地消息表是做什么的 是要保证 事务最终一致性能够成功的

我们需要用它来监控MySQL数据冗余备份和elastic search插入成功的 如果插入成功 收到ack信息 更新本地消息表 如果插入失败 重试加补偿

## 分布式事务

美团的定外卖 很少有外卖还剩几份 但是美团超市买东西的时候是有库存的（还剩几份） 从程序设计的角度要保证库存有余量 不能超卖

用户请求进来 访问的订单服务 执行两个插入一个订单插入 一个本地消息表插入 还要锁定库存

那个库存在哪个服务里面 在库存服务，订单和库存两个服务

分布式事务有哪些 seata




