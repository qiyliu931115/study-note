# StarRocks 使用物化视图进行数据建模

https://docs.mirrorship.cn/zh/docs/3.5/using_starrocks/async_mv/use_cases/data_modeling_with_materialized_views/

# 用“物化视图”做自动的微型 Cube

基础是表（传统）：数据是以明细表的形式存进去的，随时可以 Update，非常灵活。

上层是自动 Cube（多维）：你可以创建一个 “物化视图” (Materialized View)。

比如你建了一个视图：按天、按部门汇总销售额。

StarRocks 会在后台自动维护这张“小表”。

当有新数据进来，它自动更新这张小表。

当你查汇总数据时，它自动把你的 SQL 路由到这张小表上，速度和查 Cube 一样快。

# 如何自动维护物化视图

在 StarRocks 中，“自动维护”和“自动路由”是两个独立的机制。根据你的物化视图类型（是单表简单聚合还是多表复杂关联），“自动维护”的配置方式完全不同。

我们把它们分为**“实时同步模式”和“异步刷新模式”**来讲，这对应了两种不同的配置：

# 实时同步模式（单表聚合）

场景：正如你举的例子，“按天、按部门汇总销售额”。

数据都在一张大表里，只是需要预先算好 Sum/Count。 

维护方式：完全无需配置，它是“写入即更新”的。

配置方法： 你只需要写标准的 Create 语句，不需要设置任何“定时任务”。

```sql
CREATE MATERIALIZED VIEW 每日部门销售汇总
AS
SELECT 
  date_trunc('day', 销售时间) as 日期, 
  部门ID, 
  SUM(销售金额) as 总金额
FROM 销售明细表
GROUP BY date_trunc('day', 销售时间), 部门ID;

```

## 后台是怎么“自动维护”的？（原理）

原子性写入：当你往【销售明细表】里 INSERT 一条数据时，StarRocks 引擎内部会开启一个事务。

双写：它会同时把这条数据写入【明细表】和【物化视图】（当然，写入物化视图时会自动把金额加到对应的日期/部门上）。

生效：只有两边都写成功了，这次 Insert 才算成功。

结果：完全没有延迟。你刚插进去数据，查物化视图立马就是最新的。

# 异步刷新模式（多表关联/复杂计算）

你需要把“订单表” join “商品表” join “部门表”，然后做复杂的去重计算。

这种太重了，没法做到“写入即更新”。 维护方式：需要配置刷新策略（Refresh Strategy）。

配置方法： 在创建语句的最后，加上 REFRESH 相关的配置参数。

```sql
CREATE MATERIALIZED VIEW 复杂经营分析表
DISTRIBUTED BY HASH(订单ID)
REFRESH ASYNC EVERY(INTERVAL 10 MINUTE)  -- <--- 关键配置在这里
AS 
SELECT t1.id, t2.name, ... 
FROM table1 t1 JOIN table2 t2 ON ...
```

## 有哪些配置选项？

### REFRESH ASYNC (异步自动刷新)：

EVERY(INTERVAL n MINUTE/HOUR/DAY)：最常用。你可以配置每隔 5 分钟、或者每天凌晨自动刷一次。

原理：后台会有个调度器，时间一到，就去计算增量数据，更新物化视图。

### REFRESH MANUAL (手动刷新)：

不自动更。适合那种“T+1”报表，你希望每天 ETL 跑完后，手动发一个命令 REFRESH MATERIALIZED VIEW xxx 让它更新。

### PARTITION (分区智能刷新)：

StarRocks 非常聪明。如果你的底表是按天分区的，当你只更新了“今天”的数据，

它**只会重算“今天”**的分区，不会把几年的历史数据都重算一遍。

这是它比传统 ETL(Extract（抽取） → Transform（转换） → Load（加载）) 快的原因。

## 那它怎么知道要“路由”呢？（Query Rewrite）

用户操作： 你依然写你熟悉的 SQL，查的是底表：

后台动作（CBO 优化器）：

拦截：StarRocks 收到 SQL。

匹配：优化器查看元数据：“哎？用户想查部门汇总，我刚好有个【每日部门销售汇总】的物化视图，里面的数据能满足这个查询。”

改写：优化器偷偷地把你的 SQL 里的 FROM 销售明细表 替换成了 FROM 每日部门销售汇总。

执行：直接扫描那个只有几百行的小表，而不是几亿行的大表。

## 怎么验证它生效了？ 

你可以执行 EXPLAIN + 你的SQL。 在执行计划里，如果你看到扫描的表名变成了物化视图的名字（比如 Rollup: 每日部门销售汇总），就说明自动路由成功了。
