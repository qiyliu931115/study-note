美团最初是存储到MySQL

然后做订单的水平拆分（使用my cat，sharding jdbc等，例如用户ID算hash分片值，查询一张表就能得到用户订单）

商家订单查询的时候，发现商家ID不是分片键 （就会扫描所有的MySQL的水平节点）

当时美团做了一个架构调整：冗余

把当前订单数据复制冗余出来，全量安装商家ID进行再次分片

后面发现用户多了 商家多了 纠纷也多了 还需要用订单号查询 例如退款，申诉等

还是照葫芦画瓢 再次根据订单ID 全量冗余数据 （空间换时间的思路， 花钱加机器分片）

后来发现老板 管理层要看报表 做数据分析 对业务部门进行支撑 做多维度的复杂的聚合计算

这个时候美团引入了elastic search 作为订单数据的第四份冗余 负责复杂的聚合操作和查询操作

可以用kafka spark数据流将数据异步存储的es 为什么还要MySQL 为什么还要MySQL呢

elastic search （添可现在用的star rocks也是）属于OLAP型数据库 A是analyze分析型数据库 

而商品交易订单 商家订单接收 配送员信息 扣费信息 所以操作都需要落到库里面 这时候就需要我们数据库的事务

这个时候就需要我们OLTP T是transaction，所以我们无法摆脱关系型数据库


## elastic search和MySQL插入性能对比

## MySQL

插入操作为行级写入，通常是 顺序写入 + 索引更新。
如果索引较多、事务较复杂，会影响写入速度。
单机性能非常稳定，单条插入延迟低。
支持批量插入（INSERT INTO ... VALUES (...), (...), ...），性能可提升数倍。

MySQL更新是 原地修改行数据，需要行锁或事务锁。
更新时会修改索引项。
如果更新频繁、索引多，性能下降明显。
但事务一致性很好。

### Elasticsearch

插入（index）操作其实是 写入一个新文档，同时更新倒排索引。
ES 是 分布式架构，写入时会：
路由到对应分片（shard）
写入 segment（不可变文件）
定期合并 segment（merge）
因此写入速度很高，但延迟略大，且写入后不是立即可搜索（需要 refresh）。

ES 的更新其实是：
删除旧文档（标记删除）
插入新文档（重新索引）
所以更新成本 ≈ 删除 + 插入。
更新频繁会导致 segment merge 频繁，影响性能。
ES 更适合“写一次，多次读”的场景。

